<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smoke Fest 2025 - Official NFT Mint</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap'); body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto bg-gray-800 rounded-2xl shadow-lg p-8 border border-gray-700">
        
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-cyan-400">Smoke Fest 2025</h1>
            <p class="text-gray-400 mt-2">Mint your official NFT memento.</p>
        </div>

        <div class="bg-gray-700/50 rounded-lg p-4 mb-6 space-y-2 text-center">
            <div class="text-lg">
                <span id="ticketsSold" class="font-bold text-2xl text-white">--</span> / 
                <span class="text-gray-400">100</span> Minted
            </div>
            <div class="text-lg">
                Price: <span class="font-bold text-2xl text-cyan-400">0.005</span> AVAX
            </div>
        </div>
        
        <div id="connectView">
             <button id="connectButton" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg transition">Connect Wallet to Mint</button>
        </div>
        
        <div id="mintView" class="hidden">
            <button id="mintButton" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg transition disabled:bg-gray-600 disabled:cursor-not-allowed">Mint My NFT</button>
        </div>

        <div id="statusMessage" class="mt-6 text-center text-sm min-h-[20px]"></div>
    </div>

    <script>
        // --- Final Contract Configuration ---
        const contractAddress = "0x4d6F8FcA5Bb7208cceB4e7E88Cef8Ea68209dC91";
        const fujiChainId = '0xa869'; // Chain ID for Avalanche Fuji Testnet
        const ticketPriceHex = '0x11C37937E08000'; // 0.005 AVAX in wei, converted to hexadecimal

        // --- DOM Elements ---
        const connectButton = document.getElementById('connectButton');
        const mintButton = document.getElementById('mintButton');
        const connectView = document.getElementById('connectView');
        const mintView = document.getElementById('mintView');
        const statusMessage = document.getElementById('statusMessage');
        const ticketsSoldEl = document.getElementById('ticketsSold');
        
        let currentAccount = null;

        // --- Core Functions ---
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                return updateStatus('Please install MetaMask.', true);
            }
            try {
                updateStatus('Connecting wallet...', false);
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                handleAccountsChanged(accounts);
                await checkAndSwitchNetwork();
            } catch (error) {
                updateStatus(`Connection failed: ${error.message || 'User rejected connection.'}`, true);
            }
        }

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                currentAccount = null;
                connectView.classList.remove('hidden');
                mintView.classList.add('hidden');
                updateStatus('Wallet disconnected.', true);
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                connectView.classList.add('hidden');
                mintView.classList.remove('hidden');
                updateStatus('Wallet connected. Ready to mint.', false);
                updateSoldCount();
            }
        }

        async function checkAndSwitchNetwork() {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            if (chainId !== fujiChainId) {
                updateStatus('Please switch to Avalanche Fuji Testnet.', true);
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: fujiChainId }],
                    });
                } catch (switchError) {
                    updateStatus('Failed to switch network.', true);
                }
            }
        }

        async function updateSoldCount() {
            try {
                // To read from the contract, we use 'eth_call'.
                // 'data' is the first 4 bytes of the hash of the function signature.
                // For 'totalSupply()', this is 0x18160ddd.
                const hexResult = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{
                        to: contractAddress,
                        data: '0x18160ddd'
                    }, 'latest']
                });
                
                const soldCount = parseInt(hexResult, 16);
                ticketsSoldEl.textContent = soldCount;

                if (soldCount >= 100) {
                    mintButton.disabled = true;
                    mintButton.textContent = "Sold Out";
                }
            } catch (error) {
                console.error("Could not fetch total supply:", error);
                updateStatus("Could not load mint count.", true);
            }
        }

        async function mintNFT() {
            setLoadingState(true);
            try {
                updateStatus('Please confirm transaction in MetaMask...', false);
                
                const txParams = {
                    from: currentAccount,
                    to: contractAddress,
                    value: ticketPriceHex,
                    // 'data' for 'mintTicket()' function call is 0xf04f58c6
                    data: '0xf04f58c6' 
                };

                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [txParams],
                });

                updateStatus(`Minting in progress... <a href="https://testnet.snowtrace.io/tx/${txHash}" target="_blank" class="text-cyan-400 underline">View Transaction</a>`, false);
                
                await waitForTransaction(txHash);
                updateStatus(`Success! NFT Minted. <a href="https://testnet.snowtrace.io/tx/${txHash}" target="_blank" class="text-cyan-400 underline">View Transaction</a>`, false);
                await updateSoldCount();

            } catch (error) {
                updateStatus(`Error: ${error.message || "Transaction failed."}`, true);
            } finally {
                setLoadingState(false);
            }
        }

        function waitForTransaction(txHash) {
            return new Promise((resolve) => {
                const interval = setInterval(async () => {
                    const receipt = await window.ethereum.request({
                        method: 'eth_getTransactionReceipt',
                        params: [txHash],
                    });
                    if (receipt) {
                        clearInterval(interval);
                        resolve(receipt);
                    }
                }, 2000);
            });
        }
        
        // --- UI Helper Functions ---
        function updateStatus(message, isError) {
            statusMessage.innerHTML = message;
            statusMessage.className = `mt-6 text-center text-sm min-h-[20px] ${isError ? 'text-red-400' : 'text-gray-400'}`;
        }
        
        function setLoadingState(isLoading) {
             mintButton.disabled = isLoading;
             mintButton.textContent = isLoading ? 'Processing...' : 'Mint My NFT';
        }
        
        // --- Event Listeners & Initial Load ---
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', handleAccountsChanged);
        }
        
        connectButton.addEventListener('click', connectWallet);
        mintButton.addEventListener('click', mintNFT);
        
        updateSoldCount(); // Load mint count on page load
    </script>
</body>
</html>

